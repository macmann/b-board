// Prisma schema file for Mini Jira
// datasource and generator configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PO
  DEV
  QA
  VIEWER
}

enum WorkspaceMemberRole {
  OWNER
  MEMBER
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

enum EpicStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum IssueType {
  STORY
  BUG
  TASK
}

enum IssueStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IssueHistoryField {
  STATUS
  ASSIGNEE
  STORY_POINTS
  SPRINT
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  avatarUrl    String?
  role         Role     @default(VIEWER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspaces         WorkspaceMember[]
  projectMemberships ProjectMember[]
  sentInvitations    Invitation[] @relation("InvitationsSent")
  reportedIssues     Issue[]      @relation("ReportedIssues")
  assignedIssues     Issue[]      @relation("AssignedIssues")
  comments           Comment[]
  historyEntries     IssueHistory[]
}

model Workspace {
  id        String            @id @default(cuid())
  name      String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  members      WorkspaceMember[]
  projects     Project[]
  invitations  Invitation[]
}

model WorkspaceMember {
  id           String                @id @default(cuid())
  workspaceId  String
  userId       String
  role         WorkspaceMemberRole   @default(MEMBER)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  workspace    Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model Project {
  id            String    @id @default(cuid())
  workspaceId   String
  key           String
  name          String
  description   String?
  isArchived    Boolean   @default(false)
  jiraProjectKey String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members       ProjectMember[]
  invitations   Invitation[]
  inviteTokens  InviteToken[]
  sprints       Sprint[]
  epics         Epic[]
  issues        Issue[]

  @@unique([workspaceId, key])
}

model Invitation {
  id           String   @id @default(uuid())
  email        String
  token        String   @unique
  workspaceId  String
  projectId    String?
  invitedById  String
  role         Role
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  invitedBy   User      @relation("InvitationsSent", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([email])
}

model ProjectMember {
  id         String   @id @default(cuid())
  projectId  String
  userId     String
  role       Role     @default(VIEWER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Sprint {
  id          String        @id @default(cuid())
  projectId   String
  name        String
  goal        String?
  startDate   DateTime?
  endDate     DateTime?
  status      SprintStatus  @default(PLANNED)
  jiraSprintId String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues      Issue[]
}

model Epic {
  id          String      @id @default(cuid())
  projectId   String
  title       String
  description String?
  status      EpicStatus  @default(TODO)
  jiraEpicKey String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues      Issue[]
}

model Issue {
  id           String        @id @default(cuid())
  projectId    String
  key          String?       @unique
  sprintId     String?
  epicId       String?
  type         IssueType
  title        String
  description  String?
  status       IssueStatus   @default(TODO)
  priority     IssuePriority @default(MEDIUM)
  position     Float         @default(0)
  storyPoints  Int?
  assigneeId   String?
  reporterId   String?
  jiraIssueKey String?
  jiraIssueId  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint       Sprint?       @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  epic         Epic?         @relation(fields: [epicId], references: [id], onDelete: SetNull)
  assignee     User?         @relation("AssignedIssues", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter     User?         @relation("ReportedIssues", fields: [reporterId], references: [id], onDelete: SetNull)
  comments     Comment[]
  history      IssueHistory[]

  @@index([projectId])
  @@index([sprintId])
  @@index([epicId])
  @@index([assigneeId])
}

model Comment {
  id        String   @id @default(cuid())
  issueId   String
  authorId  String?
  body      String
  createdAt DateTime @default(now())

  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author    User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
}

model IssueHistory {
  id         String             @id @default(cuid())
  issueId    String
  changedById String?
  field      IssueHistoryField
  oldValue   String?
  newValue   String?
  createdAt  DateTime           @default(now())

  issue      Issue              @relation(fields: [issueId], references: [id], onDelete: Cascade)
  changedBy  User?              @relation(fields: [changedById], references: [id], onDelete: SetNull)
}

model InviteToken {
  id         String   @id @default(cuid())
  token      String   @unique
  email      String?
  projectId  String
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}
