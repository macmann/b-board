// Prisma schema file for B Board
// datasource and generator configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PO
  DEV
  QA
  VIEWER
}

enum WorkspaceMemberRole {
  OWNER
  MEMBER
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

enum EpicStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum IssueType {
  STORY
  BUG
  TASK
}

enum IssueStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TestCaseType {
  POSITIVE
  NEGATIVE
}

enum TestCasePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TestCaseStatus {
  DRAFT
  READY
  DEPRECATED
}

enum TestResultStatus {
  NOT_RUN
  PASS
  FAIL
  BLOCKED
}

enum BuildStatus {
  PLANNED
  IN_PROGRESS
  DEPLOYED
  ROLLED_BACK
  CANCELLED
}

enum BuildEnvironment {
  DEV
  STAGING
  UAT
  PROD
}

enum ResearchStatus {
  BACKLOG
  IN_PROGRESS
  REVIEW
  COMPLETED
  ARCHIVED
}

enum ResearchPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ResearchDecision {
  PENDING
  APPROVED
  REJECTED
  DEFERRED
}

enum AuditActorType {
  USER
  SYSTEM
  AI
}

enum AuditEntityType {
  PROJECT
  ISSUE
  SPRINT
  COMMENT
  AI_SUGGESTION
  AI_RUN
  SETTINGS
}

enum FeatureType {
  BACKLOG_GROOMING
}

enum AIRunStatus {
  STARTED
  SUCCEEDED
  FAILED
}

enum AISuggestionTargetType {
  ISSUE
}

enum AISuggestionStatus {
  PROPOSED
  ACCEPTED
  REJECTED
  APPLIED
  SNOOZED
}

enum ResearchObservationType {
  INTERVIEW
  SURVEY
  ANALYTICS
  USABILITY_TEST
  NOTE
  OTHER
}

enum EmailProviderType {
  SMTP
  API
  MS365
  GOOGLE_MAIL
}

enum IssueHistoryField {
  STATUS
  ASSIGNEE
  SECONDARY_ASSIGNEE
  STORY_POINTS
  SPRINT
  TYPE
  PRIORITY
  EPIC
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  avatarUrl    String?
  role         Role     @default(VIEWER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspaces            WorkspaceMember[]
  projectMemberships    ProjectMember[]
  sentInvitations       Invitation[]        @relation("InvitationsSent")
  reportedIssues        Issue[]             @relation("ReportedIssues")
  assignedIssues        Issue[]             @relation("AssignedIssues")
  secondaryAssignedIssues Issue[]           @relation("SecondaryAssignedIssues")
  comments              Comment[]
  historyEntries        IssueHistory[]
  assignedResearchItems ResearchItem[]      @relation("ResearchItemAssignee")
  standupEntries        DailyStandupEntry[]
  standupAttendances    StandupAttendance[]
  uploadedAttachments   Attachment[]
  aiRuns                AIRun[]             @relation("AIRunCreatedBy")
  aiSuggestionsDecided  AISuggestion[]      @relation("AISuggestionDecisionUser")
  createdBuilds         Build[]             @relation("BuildCreatedBy")
  createdTestCases      TestCase[]          @relation("TestCaseCreatedBy")
  testExecutions        TestExecution[]     @relation("TestExecutionExecutedBy")
  facilitatorNotesAuthored FacilitatorNote[] @relation("FacilitatorNoteAuthor")
  facilitatorNotesForTeammate FacilitatorNote[] @relation("FacilitatorNoteTeammate")
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  projects    Project[]
  invitations Invitation[]
}

model WorkspaceMember {
  id          String              @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceMemberRole @default(MEMBER)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model Project {
  id                  String   @id @default(cuid())
  workspaceId         String
  key                 String
  name                String
  description         String?
  iconUrl             String?
  isArchived          Boolean  @default(false)
  enableResearchBoard Boolean  @default(false)
  jiraProjectKey      String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  workspace          Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members            ProjectMember[]
  invitations        Invitation[]
  inviteTokens       InviteToken[]
  sprints            Sprint[]
  epics              Epic[]
  issues             Issue[]
  researchItems      ResearchItem[]
  standupEntries     DailyStandupEntry[]
  attachments        Attachment[]
  settings           ProjectSettings?
  standupSummaries   StandupSummary[]
  standupQualityDaily StandupQualityDaily[]
  standupAttendances StandupAttendance[]
  aiSummaryVersions AISummaryVersion[]
  aiSettings         ProjectAISettings?
  aiRuns             AIRun[]
  aiSuggestions      AISuggestion[]
  builds             Build[]
  testCases          TestCase[]
  facilitatorNotes   FacilitatorNote[]

  @@unique([workspaceId, key])
}

model AISummaryVersion {
  id            String   @id @default(cuid())
  projectId     String
  summaryId     String
  date          DateTime @db.Date
  version       Int
  model         String
  promptVersion String
  inputHash     String
  outputJson    Json
  createdAt     DateTime @default(now())
  createdBy     String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ai_summary_versions")
  @@unique([summaryId, version])
  @@index([projectId, date])
  @@index([summaryId])
}

model ProjectSettings {
  id                 String             @id @default(cuid())
  projectId          String             @unique
  standupWindowStart String?
  standupWindowEnd   String?
  standupWeekendDisabled Boolean         @default(false)
  standupSequence    String?
  emailProvider      EmailProviderType?
  emailFromName      String?
  emailFromAddress   String?
  emailAssignmentNotifications Boolean @default(true)
  smtpHost           String?
  smtpPort           Int?
  smtpUsername       String?
  smtpPassword       String?
  apiUrl             String?
  apiKey             String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Invitation {
  id          String    @id @default(uuid())
  email       String
  token       String    @unique
  workspaceId String
  projectId   String?
  invitedById String
  role        Role
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  invitedBy User      @relation("InvitationsSent", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([email])
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Sprint {
  id           String       @id @default(cuid())
  projectId    String
  name         String
  goal         String?
  startDate    DateTime?
  endDate      DateTime?
  status       SprintStatus @default(PLANNED)
  jiraSprintId String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues         Issue[]
  testExecutions TestExecution[]
}

model Epic {
  id          String     @id @default(cuid())
  projectId   String
  title       String
  description String?
  status      EpicStatus @default(TODO)
  jiraEpicKey String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]
}

model Issue {
  id           String        @id @default(cuid())
  projectId    String
  key          String?
  sprintId     String?
  epicId       String?
  type         IssueType
  title        String
  description  String?
  status       IssueStatus   @default(TODO)
  priority     IssuePriority @default(MEDIUM)
  position     Float         @default(0)
  storyPoints  Float?
  assigneeId   String?
  secondaryAssigneeId String?
  reporterId   String?
  jiraIssueKey String?
  jiraIssueId  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  project       Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint        Sprint?                 @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  epic          Epic?                   @relation(fields: [epicId], references: [id], onDelete: SetNull)
  assignee      User?                   @relation("AssignedIssues", fields: [assigneeId], references: [id], onDelete: SetNull)
  secondaryAssignee User?               @relation("SecondaryAssignedIssues", fields: [secondaryAssigneeId], references: [id], onDelete: SetNull)
  reporter      User?                   @relation("ReportedIssues", fields: [reporterId], references: [id], onDelete: SetNull)
  comments      Comment[]
  history       IssueHistory[]
  researchLinks ResearchItemIssueLink[]
  standupLinks  StandupEntryIssueLink[]
  attachments   Attachment[]
  buildLinks    BuildIssue[]
  testCases     TestCase[]              @relation("StoryTestCases")
  bugExecutions TestExecution[]         @relation("BugTestExecutions")

  @@index([projectId])
  @@index([sprintId])
  @@index([epicId])
  @@index([assigneeId])
  @@index([secondaryAssigneeId])
}

model Build {
  id          String           @id @default(cuid())
  projectId   String
  key         String
  name        String?
  description String?
  status      BuildStatus      @default(PLANNED)
  environment BuildEnvironment @default(DEV)
  plannedAt   DateTime?
  deployedAt  DateTime?
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  project    Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy  User?        @relation("BuildCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  issueLinks BuildIssue[]

  @@unique([projectId, key])
  @@index([projectId, status])
  @@index([projectId, environment])
}

model BuildIssue {
  id        String   @id @default(cuid())
  buildId   String
  issueId   String
  createdAt DateTime @default(now())

  build Build @relation(fields: [buildId], references: [id], onDelete: Cascade)
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([buildId, issueId])
  @@index([issueId])
}

model TestCase {
  id             String           @id @default(cuid())
  projectId      String
  storyIssueId   String?
  title          String
  type           TestCaseType
  scenario       String?
  testData       String?
  expectedResult String?
  priority       TestCasePriority @default(MEDIUM)
  status         TestCaseStatus   @default(DRAFT)
  createdById    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  storyIssue     Issue?          @relation("StoryTestCases", fields: [storyIssueId], references: [id], onDelete: SetNull)
  createdBy      User?           @relation("TestCaseCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  testExecutions TestExecution[]

  @@index([projectId])
  @@index([storyIssueId])
}

model TestExecution {
  id               String           @id @default(cuid())
  testCaseId       String
  sprintId         String?
  result           TestResultStatus @default(NOT_RUN)
  executedById     String?
  executedAt       DateTime?
  actualResult     String?
  linkedBugIssueId String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  testCase       TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  sprint         Sprint?  @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  executedBy     User?    @relation("TestExecutionExecutedBy", fields: [executedById], references: [id], onDelete: SetNull)
  linkedBugIssue Issue?   @relation("BugTestExecutions", fields: [linkedBugIssueId], references: [id], onDelete: SetNull)

  @@unique([testCaseId, sprintId])
  @@index([testCaseId])
  @@index([sprintId])
  @@index([linkedBugIssueId])
}

model Comment {
  id        String   @id @default(cuid())
  issueId   String
  authorId  String?
  body      String
  createdAt DateTime @default(now())

  issue       Issue        @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author      User?        @relation(fields: [authorId], references: [id], onDelete: SetNull)
  attachments Attachment[]
}

model IssueHistory {
  id          String            @id @default(cuid())
  issueId     String
  changedById String?
  field       IssueHistoryField
  oldValue    String?
  newValue    String?
  createdAt   DateTime          @default(now())

  issue     Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  changedBy User? @relation(fields: [changedById], references: [id], onDelete: SetNull)
}

model ResearchItem {
  id          String           @id @default(cuid())
  projectId   String
  key         String           @default("")
  assigneeId  String?
  title       String
  description String?
  status      ResearchStatus   @default(BACKLOG)
  priority    ResearchPriority @default(MEDIUM)
  decision    ResearchDecision @default(PENDING)
  tags        String[]         @default([])
  dueDate     DateTime?
  position    Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  project      Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee     User?                      @relation("ResearchItemAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  observations ResearchObservation[]
  issueLinks   ResearchItemIssueLink[]
  standupLinks StandupEntryResearchLink[]
  attachments  Attachment[]

  // @@unique([projectId, key]) // removed for now
  @@index([projectId])
}

model ResearchObservation {
  id             String                  @id @default(cuid())
  researchItemId String
  type           ResearchObservationType
  content        String
  createdAt      DateTime                @default(now())

  researchItem ResearchItem @relation(fields: [researchItemId], references: [id], onDelete: Cascade)
}

model Attachment {
  id             String   @id @default(cuid())
  projectId      String?
  issueId        String?
  commentId      String?
  researchItemId String?
  uploadedById   String
  fileName       String
  mimeType       String
  size           Int
  url            String
  createdAt      DateTime @default(now())

  project      Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issue        Issue?        @relation(fields: [issueId], references: [id], onDelete: Cascade)
  comment      Comment?      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  researchItem ResearchItem? @relation(fields: [researchItemId], references: [id], onDelete: Cascade)
  uploadedBy   User          @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([issueId])
  @@index([commentId])
  @@index([researchItemId])
}

model ResearchItemIssueLink {
  id             String   @id @default(cuid())
  researchItemId String
  issueId        String
  createdAt      DateTime @default(now())

  researchItem ResearchItem @relation(fields: [researchItemId], references: [id], onDelete: Cascade)
  issue        Issue        @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([researchItemId, issueId])
  @@index([issueId])
}

model DailyStandupEntry {
  id                     String   @id @default(cuid())
  projectId              String
  userId                 String
  date                   DateTime @db.Date
  summaryToday           String?
  progressSinceYesterday String?
  blockers               String?
  dependencies           String?
  notes                  String?
  isComplete             Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  project  Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user     User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  issues   StandupEntryIssueLink[]
  research StandupEntryResearchLink[]

  @@unique([projectId, userId, date])
  @@index([projectId])
  @@index([userId])
}

model StandupEntryIssueLink {
  id             String   @id @default(cuid())
  standupEntryId String
  issueId        String
  createdAt      DateTime @default(now())

  standupEntry DailyStandupEntry @relation(fields: [standupEntryId], references: [id], onDelete: Cascade)
  issue        Issue             @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([standupEntryId, issueId])
  @@index([issueId])
}

model StandupEntryResearchLink {
  id             String   @id @default(cuid())
  standupEntryId String
  researchItemId String
  createdAt      DateTime @default(now())

  standupEntry DailyStandupEntry @relation(fields: [standupEntryId], references: [id], onDelete: Cascade)
  researchItem ResearchItem      @relation(fields: [researchItemId], references: [id], onDelete: Cascade)

  @@unique([standupEntryId, researchItemId])
  @@index([researchItemId])
}

model StandupSummary {
  id        String   @id @default(cuid())
  projectId String
  date      DateTime @db.Date
  summary   String
  createdAt DateTime @default(now()) @db.Date

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, date])
  @@index([projectId])
}

model StandupAttendance {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  date      DateTime
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId, date])
  @@index([projectId])
  @@index([userId])
}

model StandupQualityDaily {
  id           String   @id @default(cuid())
  projectId    String
  date         DateTime @db.Date
  qualityScore Int
  metricsJson  Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, date])
  @@index([projectId])
}

model FacilitatorNote {
  id         String   @id @default(cuid())
  projectId  String
  teammateId String
  date       DateTime @db.Date
  authorId   String
  text       String
  createdAt  DateTime @default(now())
  resolved   Boolean  @default(false)
  resolvedAt DateTime?

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  teammate User    @relation("FacilitatorNoteTeammate", fields: [teammateId], references: [id], onDelete: Cascade)
  author   User    @relation("FacilitatorNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([projectId, date])
  @@index([projectId, teammateId])
  @@index([authorId])
}

model InviteToken {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String?
  projectId String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectAISettings {
  id                     String   @id @default(cuid())
  projectId              String   @unique
  backlogGroomingEnabled Boolean  @default(false)
  model                  String?
  temperature            Float?
  projectBrief           String?  @db.Text
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AIRun {
  id              String      @id @default(cuid())
  projectId       String
  featureType     FeatureType
  status          AIRunStatus
  startedAt       DateTime    @default(now())
  finishedAt      DateTime?
  createdByUserId String?
  inputSnapshot   Json
  outputRaw       Json?
  errorMessage    String?
  createdAt       DateTime    @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("AIRunCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([featureType])
}

model AISuggestion {
  id              String                 @id @default(cuid())
  projectId       String
  featureType     FeatureType
  targetType      AISuggestionTargetType
  targetId        String
  suggestionType  String
  title           String
  rationale       String
  confidence      Float
  payload         Json
  status          AISuggestionStatus     @default(PROPOSED)
  decidedByUserId String?
  decidedAt       DateTime?
  snoozedUntil    DateTime?
  createdAt       DateTime               @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  decidedBy User?   @relation("AISuggestionDecisionUser", fields: [decidedByUserId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([targetType, targetId])
}

model AuditLog {
  id         String          @id @default(cuid())
  projectId  String?
  actorType  AuditActorType
  actorId    String?
  action     String
  entityType AuditEntityType
  entityId   String?
  summary    String
  before     Json?
  after      Json?
  metadata   Json?
  createdAt  DateTime        @default(now())

  @@index([projectId])
  @@index([entityType, entityId])
  @@index([actorType, actorId])
  @@index([createdAt])
}
